name: OpenCode Agent (Windows self-hosted, Python)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: opencode-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  opencode_from_issue_comment:
    # 1) 肄붾찘?몄뿉 /oc ?ы븿
    # 2) PR 肄붾찘?멸? ?꾨땶 "Issue 肄붾찘?????뚮쭔
    # 3) 沅뚰븳 ?덈뒗 ?ъ슜?먮쭔(OWNER/MEMBER/COLLABORATOR)
    if: >
      contains(github.event.comment.body, '/oc') &&
      github.event.issue.pull_request == null &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')

    runs-on: [self-hosted, windows, x64, home-desktop]
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node (for OpenCode)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ensure OpenCode installed
        shell: pwsh
        run: |
          if (-not (Get-Command opencode -ErrorAction SilentlyContinue)) {
            npm i -g opencode-ai
          }
          opencode --version

      - name: Configure git identity
        shell: pwsh
        run: |
          git config user.name  "opencode-bot"
          git config user.email "opencode-bot@users.noreply.github.com"

      - name: Create work branch
        id: branch
        shell: pwsh
        run: |
          $branch = "oc/issue-${{ github.event.issue.number }}-${{ github.run_id }}"
          git checkout -b $branch
          "branch=$branch" >> $env:GITHUB_OUTPUT

      - name: Prepare Python env (venv + deps)
        shell: pwsh
        run: |
          python -m venv .venv
          .\.venv\Scripts\python -m pip install --upgrade pip

          if (Test-Path "pyproject.toml") {
            .\.venv\Scripts\python -m pip install -e .
          } elseif (Test-Path "requirements.txt") {
            .\.venv\Scripts\python -m pip install -r requirements.txt
          } elseif (Test-Path "setup.py") {
            .\.venv\Scripts\python -m pip install -e .
          } else {
            Write-Host "No pyproject/requirements/setup found. Skipping dependency install."
          }

          .\.venv\Scripts\python -m pip install pytest

      - name: Run OpenCode agent
        shell: pwsh
        env:
          # ??GitHub Secrets??OPENAI_API_KEY瑜?留뚮뱾?대몢硫??먮룞 二쇱엯?⑸땲??
          # ?ㅻⅨ 紐⑤뜽 ?ㅻ? ?곕젮硫??ш린 ?대쫫??留욎떠 諛붽씀?몄슂.
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE:  ${{ github.event.issue.title }}
          ISSUE_BODY:   ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          REPO:         ${{ github.repository }}
        run: |
          # "/oc" ?ㅼ쓽 ?띿뒪?몃? 吏?쒕Ц?쇰줈 ?ъ슜
          $instruction = $env:COMMENT_BODY -replace '(?s)^.*?/oc\s*', ''
          $instruction = $instruction.Trim()
          if ([string]::IsNullOrWhiteSpace($instruction)) {
            $instruction = "???댁뒋瑜??닿껐?댁쨾. 蹂寃쎌궗??쓣 而ㅻ컠?섍퀬 ?뚯뒪?멸퉴吏 ?ㅽ뻾?????붿빟 由ы룷?몃? 留뚮뱾?댁쨾."
          }

          $prompt = @"
?뱀떊? ??μ냼($env:REPO)???뚯씠??肄붾뵫 ?먯씠?꾪듃?낅땲?? ?꾨옒 ?댁뒋瑜??닿껐?섏꽭??

[Issue #$env:ISSUE_NUMBER] $env:ISSUE_TITLE
--- Issue Body ---
$env:ISSUE_BODY
------------------

[User instruction]
$instruction

?꾩닔 ?붽뎄?ы빆:
1) 理쒖냼 蹂寃쎌쑝濡??닿껐(遺덊븘?뷀븳 由ы룷留?????섏젙 湲덉?).
2) ?뚯뒪?몃뒗 Windows venv(.venv)濡??ㅽ뻾:
   - .venv\Scripts\python -m pytest -q
3) ?뚯뒪??濡쒓렇 ??? pytest_output.txt (stdout/stderr ?ы븿)
4) 由ы룷???뚯씪 ?앹꽦: opencode_report.md
   - ?붿빟(臾댁뾿/???대뼸寃?
   - 蹂寃??뚯씪 紐⑸줉
   - ?ㅽ뻾??紐낅졊(?ㅼ튂/?뚯뒪???ы븿)怨?寃곌낵
   - ?⑥? 由ъ뒪??異붽? ?쒖븞
5) 留덉?留됱뿉 git diff 湲곗? 蹂寃쎌궗??씠 議댁옱?댁빞 ?⑸땲??
"@

          opencode run "$prompt"

      - name: Run pytest (always capture logs)
        shell: pwsh
        run: |
          if (-not (Test-Path ".\.venv\Scripts\python.exe")) {
            "venv not found; pytest skipped." | Out-File -Encoding UTF8 "pytest_output.txt"
            exit 0
          }

          try {
            .\.venv\Scripts\python -m pytest -q *>&1 | Tee-Object -FilePath "pytest_output.txt"
          } catch {
            "pytest failed. See log above." | Out-File -Append -Encoding UTF8 "pytest_output.txt"
          }

          if (-not (Test-Path "opencode_report.md")) {
            @"
# OpenCode Report (fallback)

(?먯씠?꾪듃媛 opencode_report.md ?앹꽦???꾨씫?덉뒿?덈떎. Actions 濡쒓렇? pytest_output.txt瑜??뺤씤?섏꽭??)
"@ | Out-File -Encoding UTF8 "opencode_report.md"
          }

          $tail = (Get-Content "pytest_output.txt" -Tail 80) -join "`n"
          Add-Content -Encoding UTF8 "opencode_report.md" "`n---`n## Pytest log (tail)`n```text`n$tail`n```"

      - name: Commit changes (if any)
        id: commit
        shell: pwsh
        run: |
          git add -A
          $status = git status --porcelain
          if ([string]::IsNullOrWhiteSpace($status)) {
            echo "no_changes=true" >> $env:GITHUB_OUTPUT
            exit 0
          }
          git commit -m "OpenCode: resolve issue #${{ github.event.issue.number }}"
          echo "no_changes=false" >> $env:GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.commit.outputs.no_changes == 'false'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.branch.outputs.branch }}
          title: "OpenCode: Issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          body: |
            Closes #${{ github.event.issue.number }}

            ## OpenCode outputs
            - Report: `opencode_report.md`
            - Test log: `pytest_output.txt`
          labels: |
            opencode
            automated-pr

      - name: Comment back to Issue with PR + summary
        if: steps.commit.outputs.no_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('opencode_report.md', 'utf8');
            const preview = report.length > 3500 ? report.slice(0, 3500) + "\n\n...(truncated)" : report;
            const prUrl = `${{ steps.cpr.outputs.pull-request-url }}`;

            const body =
`??OpenCode ?묒뾽 ?꾨즺: PR ?앹꽦??
- PR: ${prUrl}

--- ?붿빟 由ы룷??誘몃━蹂닿린 ---
\`\`\`
${preview}
\`\`\`
`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body
            });

      - name: Comment back to Issue (no changes)
        if: steps.commit.outputs.no_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: "?좑툘 OpenCode媛 ?ㅽ뻾?먯?留?而ㅻ컠??蹂寃쎌궗??씠 ?놁뿀?듬땲?? (吏?쒓? ?덈Т 異붿긽?곸씠嫄곕굹 ?대? 諛섏쁺???곹깭?????덉뼱??) Actions 濡쒓렇/pytest_output.txt/opencode_report.md瑜??뺤씤??二쇱꽭??"
            });
